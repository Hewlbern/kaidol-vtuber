# Multi-stage build for Open-LLM-VTuber Backend
# Optimized for AWS App Runner and local Docker Compose

# ============================================================================
# Stage 1: Base image with system dependencies
# ============================================================================
FROM ubuntu:22.04 AS base

# Set noninteractive mode for apt
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
    build-essential \
    libsndfile1 \
    git \
    curl \
    ffmpeg \
    libportaudio2 \
    python3.10 \
    python3.10-dev \
    python3-pip \
    g++ \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Create app user (non-root for security)
RUN useradd -m -u 1000 appuser && \
    mkdir -p /app && \
    chown -R appuser:appuser /app

# Set working directory
WORKDIR /app

# ============================================================================
# Stage 2: Python dependencies installation
# ============================================================================
FROM base AS dependencies

# Upgrade pip and install build tools
RUN python3.10 -m pip install --upgrade pip setuptools wheel

# Copy dependency files first (for better Docker layer caching)
COPY pyproject.toml ./

# ============================================================================
# Stage 3: MeloTTS installation (if needed)
# ============================================================================
FROM dependencies AS melotts

# Install MeloTTS
WORKDIR /opt/MeloTTS
RUN git clone https://github.com/myshell-ai/MeloTTS.git /opt/MeloTTS && \
    pip3 install --no-cache-dir -e . && \
    python3 -m unidic download && \
    python3 melo/init_downloads.py || true

# ============================================================================
# Stage 4: Final application image
# ============================================================================
FROM melotts AS final

# Set working directory
WORKDIR /app

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    HF_HOME=/app/models \
    MODELSCOPE_CACHE=/app/models \
    PORT=12393

# Copy application code (includes src/, config/, and all other files)
COPY --chown=appuser:appuser . .
# Verify src directory was copied
RUN test -d src/open_llm_vtuber || (echo "ERROR: src directory not found!" && exit 1)

# Install the package in editable mode (this installs all dependencies from pyproject.toml)
# Note: omegaconf==2.0.6 requires pip<24.1 due to invalid metadata, so we downgrade pip first
RUN python3.10 -m pip install --no-cache-dir "pip<24.1" && \
    python3.10 -m pip install --no-cache-dir -e . || \
    (python3.10 -m pip install --no-cache-dir torch torchaudio --index-url https://download.pytorch.org/whl/cpu && \
     python3.10 -m pip install --no-cache-dir -e .)
# Verify critical dependencies are installed
RUN python3.10 -c "import tomli, uvicorn, loguru; print('Core dependencies verified')" || \
    (echo "ERROR: Core dependencies missing!" && exit 1)

# Install optional TTS dependencies that might not be in pyproject.toml
RUN python3.10 -m pip install --no-cache-dir \
    edge-tts \
    azure-cognitiveservices-speech \
    py3-tts || true

# Create necessary directories and set ownership
RUN mkdir -p \
    cache \
    logs \
    models \
    chat_history \
    config/characters \
    config/live2d-models \
    config/shared \
    config/shared/backgrounds \
    config/shared/assets \
    config/shared/avatars \
    src/ui/frontend \
    src/ui/web_tool \
    src/ui/simple-live2d && \
    chown -R appuser:appuser /app

# Switch to app user (non-root for security)
USER appuser

# Expose port
EXPOSE 12393

# Health check
HEALTHCHECK --interval=30s --timeout=5s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:12393/health || exit 1

# Default command
CMD ["python3.10", "run_server.py"]
